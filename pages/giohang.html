<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Gi·ªè h√†ng</title>
  <link rel="stylesheet" href="../css/giohang.css">
  <style>
    .remove-item-btn {
        padding: 5px 10px;
        background-color: #dc3545; /* M√†u ƒë·ªè */
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8em;
    }
    .remove-item-btn:hover {
        background-color: #c82333;
    }
    .checkout-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
  </style>
</head>
<body>
<div id="header"></div>
  <div class="container">
    <h2>Gi·ªè h√†ng c·ªßa b·∫°n</h2>
    <a href="../pages/index.html" class="back-home">‚Üê Quay l·∫°i trang ch·ªß</a>

    <div class="total-section">
        <strong>T·ªïng ti·ªÅn: </strong><span id="total-price">0ƒë</span>
    </div>

    <form id="cart-form" action="thanhtoan.html" method="GET">
      <table>
        <thead>
          <tr>
            <th>Ch·ªçn</th>
            <th>T√™n s·∫£n ph·∫©m</th>
            <th>Ph√¢n lo·∫°i</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>Gi√°</th>
            <th>T·ªïng</th>
            <th>X√≥a</th>
          </tr>
        </thead>
        <tbody id="cart-items-body">
          <tr>
              <td colspan="7" style="text-align: center;" id="loading-cart-message">ƒêang t·∫£i gi·ªè h√†ng...</td>
          </tr>
        </tbody>
      </table>
      <button type="button" class="checkout-btn" disabled>ƒê·∫∑t h√†ng</button> 
    </form>
  </div>
<div id="footer"></div>
<script src="../js/header.js"></script>
<script src="../js/index.js"></script>

<script>
    function parsePrice(text) {
        if (!text) return 0;
        const cleanText = text.replace(/\D/g, '');
        return parseInt(cleanText) || 0;
    }

    function formatPrice(number) {
        if (typeof number !== 'number' || isNaN(number)) {
            return '0ƒë';
        }
        return number.toLocaleString('vi-VN') + 'ƒë';
    }

    function updateTotal() {
        const rows = document.querySelectorAll("#cart-items-body tr");
        let total = 0;

        rows.forEach(row => {
            // B·ªè qua c√°c d√≤ng th√¥ng b√°o (kh√¥ng ch·ª©a checkbox)
            const checkbox = row.querySelector('input[type="checkbox"]');
            if (!checkbox) return;

            const itemTotal = parseFloat(row.dataset.itemTotal);

            if (checkbox.checked && !isNaN(itemTotal)) {
                total += itemTotal;
            }
        });

        document.getElementById("total-price").innerText = formatPrice(total);
    }

    function handleRemoveItemClick(event) {
        const button = event.target;
        const productIdToRemove = button.dataset.productId;
        const variationOptionToRemove = button.dataset.variationOption;

        const cartItemsString = localStorage.getItem('cartItems');
        let cartItems = [];

        if (cartItemsString) {
            try {
                cartItems = JSON.parse(cartItemsString);
            } catch (error) {
                console.error("L·ªói ƒë·ªçc d·ªØ li·ªáu gi·ªè h√†ng khi x√≥a:", error);
                localStorage.removeItem('cartItems');
                renderCart([]);
                return;
            }
        }
        
        // ƒê√É S·ª¨A L·ªñI: Chuy·ªÉn item.productId th√†nh chu·ªói (String) tr∆∞·ªõc khi so s√°nh
        const updatedCartItems = cartItems.filter(item =>
            !(String(item.productId) === productIdToRemove && item.variation.option === variationOptionToRemove)
        );

        localStorage.setItem('cartItems', JSON.stringify(updatedCartItems));

        // Sau khi x√≥a, render l·∫°i gi·ªè h√†ng
        renderCart(updatedCartItems);
    }

    function renderCart(cartItems) {
        const tbody = document.getElementById('cart-items-body');
        tbody.innerHTML = '';

        const checkoutBtn = document.querySelector('.checkout-btn');

        if (!cartItems || cartItems.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = '<td colspan="7" style="text-align: center;">Gi·ªè h√†ng c·ªßa b·∫°n tr·ªëng.</td>';
            tbody.appendChild(emptyRow);

            if(checkoutBtn) checkoutBtn.disabled = true;
        } else {
            if(checkoutBtn) checkoutBtn.disabled = false;

            cartItems.forEach(item => {
                const row = document.createElement('tr');

                // Ki·ªÉm tra an to√†n, ƒë·∫£m b·∫£o item.variation t·ªìn t·∫°i
                const itemPrice = item.variation ? item.variation.price : 0;
                const itemOption = item.variation ? item.variation.option : 'N/A';
                
                const itemTotal = itemPrice * item.quantity;
                row.dataset.itemTotal = itemTotal;
                row.dataset.itemDetails = JSON.stringify(item);

                row.innerHTML = `
                    <td><input type="checkbox" name="selected" value="${item.productId}-${itemOption}" checked></td>
                    <td>${item.productName || 'S·∫£n ph·∫©m kh√¥ng x√°c ƒë·ªãnh'}</td>
                    <td>${itemOption}</td>
                    <td>${item.quantity}</td>
                    <td>${formatPrice(itemPrice)}</td>
                    <td>${formatPrice(itemTotal)}</td>
                    <td>
                        <button class="remove-item-btn"
                                data-product-id="${item.productId}"
                                data-variation-option="${itemOption}">
                            X√≥a
                        </button>
                    </td>
                `;
                tbody.appendChild(row);

                const checkbox = row.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', updateTotal);

                const removeButton = row.querySelector('.remove-item-btn');
                removeButton.addEventListener('click', handleRemoveItemClick);
            });
        }

        updateTotal();
    }

    // --- Logic ƒê·∫∂T H√ÄNG t·ª´ gi·ªè h√†ng ---
    const checkoutBtn = document.querySelector('.checkout-btn');

    if (checkoutBtn) {
    checkoutBtn.addEventListener('click', () => {
        const selectedRows = document.querySelectorAll("#cart-items-body tr input[type='checkbox']:checked");

        if (selectedRows.length === 0) {
            alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ ƒë·∫∑t h√†ng.");
            return;
        }

        const itemsToOrder = [];
        let itemsTotalAmount = 0;

        selectedRows.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const itemDetailsString = row.dataset.itemDetails;
            if (itemDetailsString) {
                try {
                    const item = JSON.parse(itemDetailsString);
                    itemsToOrder.push(item);
                    const itemPrice = item.variation ? item.variation.price : 0;
                    itemsTotalAmount += itemPrice * item.quantity;
                } catch (error) {
                    console.error("L·ªói ƒë·ªçc chi ti·∫øt item t·ª´ data attribute:", error);
                }
            }
        });

        const shippingFee = 30000; // Gi·∫£ ƒë·ªãnh ph√≠ v·∫≠n chuy·ªÉn
        const paymentMethod = 'Thanh to√°n khi nh·∫≠n h√†ng';

        const orderDataForSession = {
            orderId: 'DH_' + Date.now(),
            orderDate: new Date().toISOString().split('T')[0],
            paymentMethod: paymentMethod,
            shippingFee: shippingFee,
            items: itemsToOrder,
            itemsTotalAmount: itemsTotalAmount
        };

        // üëâ L∆∞u ƒë∆°n h√†ng v√†o sessionStorage ƒë·ªÉ xem chi ti·∫øt ngay sau ƒë√≥ (n·∫øu mu·ªën)
        sessionStorage.setItem('currentOrderDetails', JSON.stringify(orderDataForSession));

        // üëâ L∆∞u th√™m ƒë∆°n h√†ng v√†o danh s√°ch trong localStorage
        let currentOrders = JSON.parse(localStorage.getItem('orderedList') || '[]');
        currentOrders.push(orderDataForSession);
        localStorage.setItem('orderedList', JSON.stringify(currentOrders));

        // üëâ X√≥a item ƒë√£ ƒë·∫∑t kh·ªèi gi·ªè h√†ng
        const currentCartItemsString = localStorage.getItem('cartItems');
        if (currentCartItemsString) {
            try {
                let currentCartItems = JSON.parse(currentCartItemsString);
                const remainingCartItems = currentCartItems.filter(cartItem =>
                    !itemsToOrder.some(orderedItem =>
                        String(orderedItem.productId) === String(cartItem.productId) &&
                        (orderedItem.variation && cartItem.variation && orderedItem.variation.option === cartItem.variation.option)
                    )
                );
                localStorage.setItem('cartItems', JSON.stringify(remainingCartItems));
                console.log("ƒê√£ x√≥a c√°c m·ª•c ƒë√£ ƒë·∫∑t kh·ªèi gi·ªè h√†ng.");
            } catch (error) {
                console.error("L·ªói c·∫≠p nh·∫≠t gi·ªè h√†ng sau khi ƒë·∫∑t:", error);
            }
        }

        // üëâ Chuy·ªÉn sang trang x√°c nh·∫≠n ho·∫∑c danh s√°ch ƒë∆°n h√†ng
        // --- L∆∞u ƒë∆°n h√†ng v√†o danh s√°ch userOrders trong localStorage ---
        const existingOrders = JSON.parse(localStorage.getItem('userOrders')) || [];
        existingOrders.push(orderDataForSession);
        localStorage.setItem('userOrders', JSON.stringify(existingOrders));

        window.location.href = 'xacnhanmuahang.html'; // ho·∫∑c: 'danhsachdonhang.html'
    });
}


    // --- Logic T·∫£i Gi·ªè H√†ng khi trang load ---
    window.addEventListener('load', () => {
        const cartItemsString = localStorage.getItem('cartItems');
        let cartItems = [];

        if (cartItemsString) {
            try {
                cartItems = JSON.parse(cartItemsString);
            } catch (error) {
                console.error("L·ªói ƒë·ªçc d·ªØ li·ªáu gi·ªè h√†ng t·ª´ localStorage:", error);
                localStorage.removeItem('cartItems');
                alert("ƒê√£ x·∫£y ra l·ªói khi t·∫£i gi·ªè h√†ng. Gi·ªè h√†ng ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi.");
            }
        }

        renderCart(cartItems);
    });
</script>

</body>
</html>