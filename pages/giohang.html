<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Giỏ hàng</title>
  <link rel="stylesheet" href="../css/giohang.css">
  <style>
    .remove-item-btn {
        padding: 5px 10px;
        background-color: #dc3545; /* Màu đỏ */
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8em;
    }
    .remove-item-btn:hover {
        background-color: #c82333;
    }
    .checkout-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Giỏ hàng của bạn</h2>
    <a href="../pages/index.html" class="back-home">← Quay lại trang chủ</a>

    <div class="total-section">
        <strong>Tổng tiền: </strong><span id="total-price">0đ</span>
    </div>

    <form id="cart-form" action="thanhtoan.html" method="GET">
      <table>
        <thead>
          <tr>
            <th>Chọn</th>
            <th>Tên sản phẩm</th>
            <th>Phân loại</th>
            <th>Số lượng</th>
            <th>Giá</th>
            <th>Tổng</th>
            <th>Xóa</th>
          </tr>
        </thead>
        <tbody id="cart-items-body">
          <tr>
              <td colspan="7" style="text-align: center;" id="loading-cart-message">Đang tải giỏ hàng...</td>
          </tr>
        </tbody>
      </table>
      <button type="button" class="checkout-btn" disabled>Đặt hàng</button> 
    </form>
  </div>

<script>
    function parsePrice(text) {
        if (!text) return 0;
        const cleanText = text.replace(/\D/g, '');
        return parseInt(cleanText) || 0;
    }

    function formatPrice(number) {
        if (typeof number !== 'number' || isNaN(number)) {
            return '0đ';
        }
        return number.toLocaleString('vi-VN') + 'đ';
    }

    function updateTotal() {
        const rows = document.querySelectorAll("#cart-items-body tr");
        let total = 0;

        rows.forEach(row => {
            // Bỏ qua các dòng thông báo (không chứa checkbox)
            const checkbox = row.querySelector('input[type="checkbox"]');
            if (!checkbox) return;

            const itemTotal = parseFloat(row.dataset.itemTotal);

            if (checkbox.checked && !isNaN(itemTotal)) {
                total += itemTotal;
            }
        });

        document.getElementById("total-price").innerText = formatPrice(total);
    }

    function handleRemoveItemClick(event) {
        const button = event.target;
        const productIdToRemove = button.dataset.productId;
        const variationOptionToRemove = button.dataset.variationOption;

        const cartItemsString = localStorage.getItem('cartItems');
        let cartItems = [];

        if (cartItemsString) {
            try {
                cartItems = JSON.parse(cartItemsString);
            } catch (error) {
                console.error("Lỗi đọc dữ liệu giỏ hàng khi xóa:", error);
                localStorage.removeItem('cartItems');
                renderCart([]);
                return;
            }
        }
        
        // ĐÃ SỬA LỖI: Chuyển item.productId thành chuỗi (String) trước khi so sánh
        const updatedCartItems = cartItems.filter(item =>
            !(String(item.productId) === productIdToRemove && item.variation.option === variationOptionToRemove)
        );

        localStorage.setItem('cartItems', JSON.stringify(updatedCartItems));

        // Sau khi xóa, render lại giỏ hàng
        renderCart(updatedCartItems);
    }

    function renderCart(cartItems) {
        const tbody = document.getElementById('cart-items-body');
        tbody.innerHTML = '';

        const checkoutBtn = document.querySelector('.checkout-btn');

        if (!cartItems || cartItems.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = '<td colspan="7" style="text-align: center;">Giỏ hàng của bạn trống.</td>';
            tbody.appendChild(emptyRow);

            if(checkoutBtn) checkoutBtn.disabled = true;
        } else {
            if(checkoutBtn) checkoutBtn.disabled = false;

            cartItems.forEach(item => {
                const row = document.createElement('tr');

                // Kiểm tra an toàn, đảm bảo item.variation tồn tại
                const itemPrice = item.variation ? item.variation.price : 0;
                const itemOption = item.variation ? item.variation.option : 'N/A';
                
                const itemTotal = itemPrice * item.quantity;
                row.dataset.itemTotal = itemTotal;
                row.dataset.itemDetails = JSON.stringify(item);

                row.innerHTML = `
                    <td><input type="checkbox" name="selected" value="${item.productId}-${itemOption}" checked></td>
                    <td>${item.productName || 'Sản phẩm không xác định'}</td>
                    <td>${itemOption}</td>
                    <td>${item.quantity}</td>
                    <td>${formatPrice(itemPrice)}</td>
                    <td>${formatPrice(itemTotal)}</td>
                    <td>
                        <button class="remove-item-btn"
                                data-product-id="${item.productId}"
                                data-variation-option="${itemOption}">
                            Xóa
                        </button>
                    </td>
                `;
                tbody.appendChild(row);

                const checkbox = row.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', updateTotal);

                const removeButton = row.querySelector('.remove-item-btn');
                removeButton.addEventListener('click', handleRemoveItemClick);
            });
        }

        updateTotal();
    }

    // --- Logic ĐẶT HÀNG từ giỏ hàng ---
    const checkoutBtn = document.querySelector('.checkout-btn');

    if (checkoutBtn) {
        checkoutBtn.addEventListener('click', () => {
            const selectedRows = document.querySelectorAll("#cart-items-body tr input[type='checkbox']:checked");

            if (selectedRows.length === 0) {
                alert("Vui lòng chọn ít nhất một sản phẩm để đặt hàng.");
                return;
            }

            const itemsToOrder = [];
            let itemsTotalAmount = 0;

            selectedRows.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const itemDetailsString = row.dataset.itemDetails;
                if (itemDetailsString) {
                    try {
                        const item = JSON.parse(itemDetailsString);
                        itemsToOrder.push(item);
                        const itemPrice = item.variation ? item.variation.price : 0;
                        itemsTotalAmount += itemPrice * item.quantity;
                    } catch (error) {
                        console.error("Lỗi đọc chi tiết item từ data attribute:", error);
                    }
                }
            });

            const shippingFee = 30000; // Giả định phí vận chuyển
            const paymentMethod = 'Thanh toán khi nhận hàng';

            const orderDataForSession = {
                orderId: 'TEMP_' + Date.now(),
                orderDate: new Date().toISOString().split('T')[0],
                paymentMethod: paymentMethod,
                shippingFee: shippingFee,
                items: itemsToOrder,
                itemsTotalAmount: itemsTotalAmount
            };

            sessionStorage.setItem('currentOrderDetails', JSON.stringify(orderDataForSession));
            console.log("Lưu chi tiết đơn hàng (từ giỏ) vào sessionStorage:", orderDataForSession);

            // Xóa các item đã đặt hàng khỏi localStorage
            const currentCartItemsString = localStorage.getItem('cartItems');
            if (currentCartItemsString) {
                try {
                    let currentCartItems = JSON.parse(currentCartItemsString);
                    const remainingCartItems = currentCartItems.filter(cartItem =>
                        !itemsToOrder.some(orderedItem =>
                            String(orderedItem.productId) === String(cartItem.productId) &&
                            (orderedItem.variation && cartItem.variation && orderedItem.variation.option === cartItem.variation.option)
                        )
                    );
                    localStorage.setItem('cartItems', JSON.stringify(remainingCartItems));
                    console.log("Đã xóa các mục đã đặt khỏi giỏ hàng.");
                } catch (error) {
                    console.error("Lỗi cập nhật giỏ hàng sau khi đặt:", error);
                }
            }

            // Chuyển hướng sang trang xác nhận
            window.location.href = 'xacnhanmuahang.html';
        });
    }

    // --- Logic Tải Giỏ Hàng khi trang load ---
    window.addEventListener('load', () => {
        const cartItemsString = localStorage.getItem('cartItems');
        let cartItems = [];

        if (cartItemsString) {
            try {
                cartItems = JSON.parse(cartItemsString);
            } catch (error) {
                console.error("Lỗi đọc dữ liệu giỏ hàng từ localStorage:", error);
                localStorage.removeItem('cartItems');
                alert("Đã xảy ra lỗi khi tải giỏ hàng. Giỏ hàng đã được làm mới.");
            }
        }

        renderCart(cartItems);
    });
</script>

</body>
</html>