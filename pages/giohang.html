<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Giỏ hàng</title>
  <link rel="stylesheet" href="../css/giohang.css">
  <style>
    .remove-item-btn {
        padding: 5px 10px;
        background-color: #dc3545; /* Màu đỏ */
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8em;
    }
    .remove-item-btn:hover {
        background-color: #c82333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Giỏ hàng của bạn</h2>
    <a href="../pages/index.html" class="back-home">← Quay lại trang chủ</a>

    <div class="total-section">
        <strong>Tổng tiền: </strong><span id="total-price">0đ</span>
    </div>

    <form id="cart-form" action="thanhtoan.html" method="GET">
      <table>
        <thead>
          <tr>
            <th>Chọn</th>
            <th>Tên sản phẩm</th>
            <th>Phân loại</th>
            <th>Số lượng</th>
            <th>Giá</th>
            <th>Tổng</th>
            <th>Xóa</th>
          </tr>
        </thead>
        <tbody id="cart-items-body">
          <tr>
             <td colspan="7" style="text-align: center;" id="loading-cart-message">Đang tải giỏ hàng...</td>
          </tr>
        </tbody>
      </table>
      <button type="button" class="checkout-btn">Đặt hàng</button> </form>
  </div>

<script>
    function parsePrice(text) {
        const cleanText = text.replace(/\D/g, '');
        return parseInt(cleanText);
    }

    function formatPrice(number) {
         if (typeof number !== 'number' || isNaN(number)) {
              return '0đ';
         }
        return number.toLocaleString('vi-VN') + 'đ';
    }

    function updateTotal() {
        const rows = document.querySelectorAll("#cart-items-body tr");
        let total = 0;

        rows.forEach(row => {
             if (row.id === 'loading-cart-message' || row.id === 'empty-cart-message') {
                 return;
             }

            const checkbox = row.querySelector('input[type="checkbox"]');
             const itemTotal = parseFloat(row.dataset.itemTotal);

            if (checkbox.checked && !isNaN(itemTotal)) {
                 total += itemTotal;
            }
        });

        document.getElementById("total-price").innerText = formatPrice(total);
    }

    function handleRemoveItemClick(event) {
        const button = event.target;
        const productIdToRemove = button.dataset.productId;
        const variationOptionToRemove = button.dataset.variationOption;

        const cartItemsString = localStorage.getItem('cartItems');
        let cartItems = [];

        if (cartItemsString) {
             try {
                 cartItems = JSON.parse(cartItemsString);
             } catch (error) {
                 console.error("Lỗi đọc dữ liệu giỏ hàng khi xóa:", error);
                 localStorage.removeItem('cartItems');
                 renderCart([]);
                 return;
             }
        }

        const updatedCartItems = cartItems.filter(item =>
            !(item.productId === productIdToRemove && item.variation.option === variationOptionToRemove)
        );

        localStorage.setItem('cartItems', JSON.stringify(updatedCartItems));

        // Sau khi xóa, cần render lại giỏ hàng
        renderCart(updatedCartItems);

         // Tùy chọn: Hiển thị thông báo đã xóa
         // alert("Đã xóa sản phẩm khỏi giỏ hàng.");
    }


    function renderCart(cartItems) {
        const tbody = document.getElementById('cart-items-body');
        tbody.innerHTML = '';

        const checkoutBtn = document.querySelector('.checkout-btn'); // Lấy tham chiếu nút đặt hàng

        if (!cartItems || cartItems.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = '<td colspan="7" style="text-align: center;">Giỏ hàng của bạn trống.</td>';
            emptyRow.id = 'empty-cart-message';
            tbody.appendChild(emptyRow);

             // Vô hiệu hóa nút đặt hàng nếu giỏ hàng trống
             if(checkoutBtn) checkoutBtn.disabled = true;

        } else {
             // Bật nút đặt hàng nếu có item
              if(checkoutBtn) checkoutBtn.disabled = false;

            cartItems.forEach(item => {
                const row = document.createElement('tr');

                const itemTotal = item.variation.price * item.quantity;
                row.dataset.itemTotal = itemTotal; // Lưu tổng tiền item vào data attribute
                // Lưu cả thông tin item gốc vào data attribute (cần cho lúc đặt hàng)
                 row.dataset.itemDetails = JSON.stringify(item);


                row.innerHTML = `
                    <td><input type="checkbox" name="selected" value="${item.productId}-${item.variation.option}" checked></td>
                    <td>${item.productName}</td>
                    <td>${item.variation.option}</td>
                    <td>${item.quantity}</td>
                    <td>${formatPrice(item.variation.price)}</td>
                    <td>${formatPrice(itemTotal)}</td>
                    <td>
                         <button class="remove-item-btn"
                                 data-product-id="${item.productId}"
                                 data-variation-option="${item.variation.option}">
                              Xóa
                         </button>
                    </td>
                `;
                tbody.appendChild(row);

                const checkbox = row.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', updateTotal);

                const removeButton = row.querySelector('.remove-item-btn');
                removeButton.addEventListener('click', handleRemoveItemClick);

            });
        }

        updateTotal();
    }

    // --- Logic ĐẶT HÀNG từ giỏ hàng ---
    const checkoutBtn = document.querySelector('.checkout-btn'); // Lấy tham chiếu nút đặt hàng

    if (checkoutBtn) {
        checkoutBtn.addEventListener('click', () => {
            // Lấy tất cả các dòng sản phẩm có checkbox được chọn
            const selectedRows = document.querySelectorAll("#cart-items-body tr input[type='checkbox']:checked");

            if (selectedRows.length === 0) {
                alert("Vui lòng chọn ít nhất một sản phẩm để đặt hàng.");
                return;
            }

            const itemsToOrder = [];
            let itemsTotalAmount = 0; // Tính tổng tiền hàng của các mục đã chọn

            selectedRows.forEach(checkbox => {
                 // Lấy dòng cha (<tr>) của checkbox
                const row = checkbox.closest('tr');
                // Lấy thông tin item đã lưu trong data attribute của dòng
                const itemDetailsString = row.dataset.itemDetails;
                if (itemDetailsString) {
                     try {
                          const item = JSON.parse(itemDetailsString);
                          itemsToOrder.push(item);
                          itemsTotalAmount += item.variation.price * item.quantity; // Cộng vào tổng tiền hàng
                     } catch (error) {
                          console.error("Lỗi đọc chi tiết item từ data attribute:", error);
                     }
                }
            });

             // Giả định phí vận chuyển và phương thức thanh toán cho đơn hàng từ giỏ
             // Trong thực tế, phí VC có thể cần tính toán phức tạp hơn
             const shippingFee = 30000; // Giả định phí vận chuyển cố định
             const paymentMethod = 'Thanh toán khi nhận hàng'; // Giả định phương thức TT

            // Chuẩn bị dữ liệu đơn hàng để lưu vào sessionStorage
            const orderDataForSession = {
                orderId: 'TEMP_' + Date.now(), // ID đơn hàng tạm thời
                orderDate: new Date().toISOString().split('T')[0], // Ngày đặt hàng
                paymentMethod: paymentMethod,
                shippingFee: shippingFee,
                items: itemsToOrder, // Danh sách các items đã chọn từ giỏ hàng
                itemsTotalAmount: itemsTotalAmount // Tổng tiền hàng của các mục đã chọn
            };

            // Lưu dữ liệu đơn hàng vào sessionStorage
            sessionStorage.setItem('currentOrderDetails', JSON.stringify(orderDataForSession));
            console.log("Lưu chi tiết đơn hàng (từ giỏ) vào sessionStorage:", orderDataForSession);


            // Tùy chọn: Xóa các item đã đặt hàng khỏi localStorage (giỏ hàng)
            // Bạn có thể muốn xóa CHỈ CÁC MỤC ĐÃ CHỌN khỏi localStorage
             const currentCartItemsString = localStorage.getItem('cartItems');
             if (currentCartItemsString) {
                 try {
                      let currentCartItems = JSON.parse(currentCartItemsString);
                      // Tạo mảng mới chỉ giữ lại những item KHÔNG có trong danh sách itemsToOrder
                      const remainingCartItems = currentCartItems.filter(cartItem =>
                           !itemsToOrder.some(orderedItem =>
                                orderedItem.productId === cartItem.productId &&
                                orderedItem.variation.option === cartItem.variation.option
                           )
                      );
                      localStorage.setItem('cartItems', JSON.stringify(remainingCartItems));
                       console.log("Đã xóa các mục đã đặt khỏi giỏ hàng trong localStorage.");

                 } catch (error) {
                      console.error("Lỗi cập nhật giỏ hàng sau khi đặt:", error);
                 }
             }


            // Chuyển hướng sang trang chi tiết đơn hàng
            window.location.href = 'xacnhanmuahang.html'; // Điều chỉnh đường dẫn nếu cấu trúc khác
        });
    }


    // --- Logic Tải Giỏ Hàng khi trang load ---
    window.addEventListener('load', () => {
        const cartItemsString = localStorage.getItem('cartItems');
        let cartItems = [];

        if (cartItemsString) {
            try {
                cartItems = JSON.parse(cartItemsString);
            } catch (error) {
                console.error("Lỗi đọc dữ liệu giỏ hàng từ localStorage:", error);
                localStorage.removeItem('cartItems');
                alert("Đã xảy ra lỗi khi tải giỏ hàng. Giỏ hàng đã được làm mới.");
            }
        }

        renderCart(cartItems);
    });

</script>

</body>
</html>